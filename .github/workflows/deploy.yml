name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-southeast1
  VM_INSTANCE: microservices-vm
  VM_ZONE: asia-southeast1-a

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests
        run: mvn test

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jar-files
          path: |
            */target/*.jar
          retention-days: 1

  build-docker-images:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: jar-files

      - name: Build and Push Docker Images
        run: |
          SERVICES=("product-service" "order-service" "inventory-service" "notification-service" "api-gateway" "discovery-server")
          
          for SERVICE in "${SERVICES[@]}"; do
            echo "Building $SERVICE..."
            cd $SERVICE
          
            # Build image using Jib or Dockerfile
            if [ -f "Dockerfile" ]; then
              docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/microservices-repo/$SERVICE:${{ github.sha }} .
              docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/microservices-repo/$SERVICE:latest .
              docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/microservices-repo/$SERVICE:${{ github.sha }}
              docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/microservices-repo/$SERVICE:latest
            fi
          
            cd ..
          done

  deploy-to-vm:
    needs: build-docker-images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Deploy to VM
        run: |
          # Copy docker-compose file to VM
          gcloud compute scp docker-compose.yml ${{ env.VM_INSTANCE }}:/opt/microservices/ \
            --zone=${{ env.VM_ZONE }}
          
          # Copy other necessary files
          gcloud compute scp --recurse prometheus ${{ env.VM_INSTANCE }}:/opt/microservices/ \
            --zone=${{ env.VM_ZONE }}
          
          gcloud compute scp --recurse realms-export ${{ env.VM_INSTANCE }}:/opt/microservices/ \
            --zone=${{ env.VM_ZONE }}
          
          # Execute deployment commands on VM
          gcloud compute ssh ${{ env.VM_INSTANCE }} \
            --zone=${{ env.VM_ZONE }} \
            --command="
              cd /opt/microservices
          
              # Configure Docker for Artifact Registry
              gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
          
              # Pull latest images
              docker-compose pull
          
              # Stop and remove old containers
              docker-compose down
          
              # Start services
              docker-compose up -d
          
              # Show status
              docker-compose ps
          
              # Clean up old images
              docker image prune -af
            "

      - name: Verify Deployment
        run: |
          VM_IP=$(gcloud compute instances describe ${{ env.VM_INSTANCE }} \
            --zone=${{ env.VM_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "Deployment completed. Services available at:"
          echo "API Gateway: http://$VM_IP:8181"
          echo "Eureka Dashboard: http://$VM_IP:8761"
          echo "Keycloak: http://$VM_IP:8080"
          echo "Grafana: http://$VM_IP:3000"
          echo "Prometheus: http://$VM_IP:9090"